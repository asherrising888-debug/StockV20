import streamlit as st
import akshare as ak
import pandas as pd
import numpy as np
import os
import time
import warnings
from datetime import datetime, timedelta

# å¿½ç•¥è­¦å‘Š
warnings.simplefilter(action='ignore', category=FutureWarning)

# ==================== âš™ï¸ æ ¸å¿ƒé…ç½® ====================
st.set_page_config(page_title="V20.6 æé€ŸæŒ‡æŒ¥èˆ±", layout="wide", page_icon="ğŸš€")

STOCK_DIR = "./stock_data_v20"

# 2030 æˆ˜ç•¥æ ¸å¿ƒèµ„äº§æ±  (å®Œæ•´ç‰ˆ)
STRATEGIC_POOL = {
    "601398": ("å·¥å•†é“¶è¡Œ", "é“¶è¡Œ"),
"601288": ("å†œä¸šé“¶è¡Œ", "é“¶è¡Œ"),
"601939": ("å»ºè®¾é“¶è¡Œ", "é“¶è¡Œ"),
"600941": ("ä¸­å›½ç§»åŠ¨", "é€šä¿¡æœåŠ¡"),
"601857": ("ä¸­å›½çŸ³æ²¹", "çŸ³æ²¹è¡Œä¸š"),
"600519": ("è´µå·èŒ…å°", "é…¿é…’è¡Œä¸š"),
"600938": ("ä¸­å›½æµ·æ²¹", "çŸ³æ²¹è¡Œä¸š"),
"601628": ("ä¸­å›½äººå¯¿", "ä¿é™©"),
"601138": ("XDå·¥ä¸šå¯Œ", "æ¶ˆè´¹ç”µå­"),
"601318": ("ä¸­å›½å¹³å®‰", "ä¿é™©"),
"601899": ("ç´«é‡‘çŸ¿ä¸š", "æœ‰è‰²é‡‘å±"),
"002594": ("æ¯”äºšè¿ª", "æ±½è½¦æ•´è½¦"),
"601088": ("ä¸­å›½ç¥å", "ç…¤ç‚­è¡Œä¸š"),
"600028": ("ä¸­å›½çŸ³åŒ–", "çŸ³æ²¹è¡Œä¸š"),
"600900": ("é•¿æ±Ÿç”µåŠ›", "ç”µåŠ›è¡Œä¸š"),
"000333": ("ç¾çš„é›†å›¢", "å®¶ç”µè¡Œä¸š"),
"601728": ("ä¸­å›½ç”µä¿¡", "é€šä¿¡æœåŠ¡"),
"603993": ("æ´›é˜³é’¼ä¸š", "å°é‡‘å±"),
"601601": ("ä¸­å›½å¤ªä¿", "ä¿é™©"),
"002475": ("ç«‹è®¯ç²¾å¯†", "æ¶ˆè´¹ç”µå­"),
"600030": ("ä¸­ä¿¡è¯åˆ¸", "è¯åˆ¸"),
"600276": ("æ’ç‘åŒ»è¯", "åŒ–å­¦åˆ¶è¯"),
"000858": ("äº” ç²® æ¶²", "é…¿é…’è¡Œä¸š"),
"002379": ("å®åˆ›æ§è‚¡", "æœ‰è‰²é‡‘å±"),
"002371": ("åŒ—æ–¹ååˆ›", "åŠå¯¼ä½“"),
"601211": ("å›½æ³°æµ·é€š", "è¯åˆ¸"),
"603259": ("è¯æ˜åº·å¾·", "åŒ»ç–—æœåŠ¡"),
"002415": ("æµ·åº·å¨è§†", "è®¡ç®—æœºè®¾å¤‡"),
"600150": ("ä¸­å›½èˆ¹èˆ¶", "èˆ¹èˆ¶åˆ¶é€ "),
"002714": ("ç‰§åŸè‚¡ä»½", "å†œç‰§é¥²æ¸”"),
"600930": ("åç”µæ–°èƒ½", "ç”µåŠ›è¡Œä¸š"),
"600309": ("ä¸‡ååŒ–å­¦", "åŒ–å­¦åˆ¶å“"),
"601816": ("äº¬æ²ªé«˜é“", "é“è·¯å…¬è·¯"),
"002050": ("ä¸‰èŠ±æ™ºæ§", "å®¶ç”µè¡Œä¸š"),
"600690": ("æµ·å°”æ™ºå®¶", "å®¶ç”µè¡Œä¸š"),
"601600": ("ä¸­å›½é“ä¸š", "æœ‰è‰²é‡‘å±"),
"601919": ("ä¸­è¿œæµ·æ§", "èˆªè¿æ¸¯å£"),
"603288": ("æµ·å¤©å‘³ä¸š", "é£Ÿå“é¥®æ–™"),
"601225": ("é™•è¥¿ç…¤ä¸š", "ç…¤ç‚­è¡Œä¸š"),
"600547": ("å±±ä¸œé»„é‡‘", "è´µé‡‘å±"),
"601668": ("ä¸­å›½å»ºç­‘", "å·¥ç¨‹å»ºè®¾"),
"601127": ("èµ›åŠ›æ–¯", "æ±½è½¦æ•´è½¦"),
"600809": ("å±±è¥¿æ±¾é…’", "é…¿é…’è¡Œä¸š"),
"601688": ("åæ³°è¯åˆ¸", "è¯åˆ¸"),
"600031": ("ä¸‰ä¸€é‡å·¥", "å·¥ç¨‹æœºæ¢°"),
"600406": ("å›½ç”µå—ç‘", "ç”µç½‘è®¾å¤‡"),
"002352": ("é¡ºä¸°æ§è‚¡", "ç‰©æµè¡Œä¸š"),
"603986": ("å…†æ˜“åˆ›æ–°", "åŠå¯¼ä½“"),
"003816": ("ä¸­å›½å¹¿æ ¸", "ç”µåŠ›è¡Œä¸š"),
"601766": ("ä¸­å›½ä¸­è½¦", "äº¤è¿è®¾å¤‡"),
"000063": ("ä¸­å…´é€šè®¯", "é€šä¿¡è®¾å¤‡"),
"601633": ("é•¿åŸæ±½è½¦", "æ±½è½¦æ•´è½¦"),
"600111": ("åŒ—æ–¹ç¨€åœŸ", "å°é‡‘å±"),
"601888": ("ä¸­å›½ä¸­å…", "æ—…æ¸¸é…’åº—"),
"000338": ("æ½æŸ´åŠ¨åŠ›", "æ±½è½¦é›¶éƒ¨ä»¶"),
"000792": ("ç›æ¹–è‚¡ä»½", "åŒ–è‚¥è¡Œä¸š"),
"600887": ("ä¼Šåˆ©è‚¡ä»½", "é£Ÿå“é¥®æ–™"),
"601898": ("ä¸­ç…¤èƒ½æº", "ç…¤ç‚­è¡Œä¸š"),
"601698": ("ä¸­å›½å«é€š", "é€šä¿¡æœåŠ¡"),
"600183": ("ç”Ÿç›Šç§‘æŠ€", "ç”µå­å…ƒä»¶"),
"600760": ("ä¸­èˆªæ²ˆé£", "èˆªå¤©èˆªç©º"),
"000725": ("äº¬ä¸œæ–¹ï¼¡", "å…‰å­¦å…‰ç”µå­"),
"600346": ("æ’åŠ›çŸ³åŒ–", "åŒ–çº¤è¡Œä¸š"),
"603501": ("è±ªå¨é›†å›¢", "åŠå¯¼ä½“"),
"600660": ("ç¦è€€ç»ç’ƒ", "ç»ç’ƒç»çº¤"),
"601100": ("æ’ç«‹æ¶²å‹", "å·¥ç¨‹æœºæ¢°"),
"002916": ("æ·±å—ç”µè·¯", "ç”µå­å…ƒä»¶"),
"001280": ("ä¸­å›½é“€ä¸š", "å°é‡‘å±"),
"600989": ("å®ä¸°èƒ½æº", "åŒ–å­¦åŸæ–™"),
"600019": ("å®é’¢è‚¡ä»½", "é’¢é“è¡Œä¸š"),
"002463": ("æ²ªç”µè‚¡ä»½", "ç”µå­å…ƒä»¶"),
"601111": ("ä¸­å›½å›½èˆª", "èˆªç©ºæœºåœº"),
"002230": ("ç§‘å¤§è®¯é£", "è½¯ä»¶å¼€å‘"),
"603799": ("åå‹é’´ä¸š", "èƒ½æºé‡‘å±"),
"002028": ("æ€æºç”µæ°”", "ç”µç½‘è®¾å¤‡"),
"002460": ("èµ£é”‹é”‚ä¸š", "èƒ½æºé‡‘å±"),
"002602": ("ä¸–çºªåé€š", "æ¸¸æˆ"),
"601727": ("ä¸Šæµ·ç”µæ°”", "ç”µæºè®¾å¤‡"),
"601012": ("éš†åŸºç»¿èƒ½", "å…‰ä¼è®¾å¤‡"),
"000408": ("è—æ ¼çŸ¿ä¸š", "åŒ–è‚¥è¡Œä¸š"),
"600089": ("ç‰¹å˜ç”µå·¥", "ç”µç½‘è®¾å¤‡"),
"601800": ("ä¸­å›½äº¤å»º", "å·¥ç¨‹å»ºè®¾"),
"605499": ("ä¸œé¹é¥®æ–™", "é£Ÿå“é¥®æ–™"),
"603019": ("ä¸­ç§‘æ›™å…‰", "è®¡ç®—æœºè®¾å¤‡"),
"600029": ("å—æ–¹èˆªç©º", "èˆªç©ºæœºåœº"),
"601390": ("ä¸­å›½ä¸­é“", "å·¥ç¨‹å»ºè®¾"),
"000425": ("å¾å·¥æœºæ¢°", "å·¥ç¨‹æœºæ¢°"),
"601689": ("æ‹“æ™®é›†å›¢", "æ±½è½¦é›¶éƒ¨ä»¶"),
"600115": ("ä¸­å›½ä¸œèˆª", "èˆªç©ºæœºåœº"),
"600489": ("ä¸­é‡‘é»„é‡‘", "è´µé‡‘å±"),
"002600": ("é¢†ç›Šæ™ºé€ ", "æ¶ˆè´¹ç”µå­"),
"600118": ("ä¸­å›½å«æ˜Ÿ", "èˆªå¤©èˆªç©º"),
"000617": ("ä¸­æ²¹èµ„æœ¬", "å¤šå…ƒé‡‘è"),
"600018": ("ä¸Šæ¸¯é›†å›¢", "èˆªè¿æ¸¯å£"),
"600585": ("æµ·èºæ°´æ³¥", "æ°´æ³¥å»ºæ"),
"002493": ("è£ç››çŸ³åŒ–", "åŒ–çº¤è¡Œä¸š"),
"002202": ("é‡‘é£ç§‘æŠ€", "é£ç”µè®¾å¤‡"),
"600010": ("åŒ…é’¢è‚¡ä»½", "é’¢é“è¡Œä¸š"),
"002625": ("å…‰å¯æŠ€æœ¯", "èˆªå¤©èˆªç©º"),
"002027": ("åˆ†ä¼—ä¼ åª’", "æ–‡åŒ–ä¼ åª’"),
"600436": ("ç‰‡ä»”ç™€", "ä¸­è¯"),
"600160": ("å·¨åŒ–è‚¡ä»½", "åŒ–å­¦åˆ¶å“"),
"601006": ("å¤§ç§¦é“è·¯", "ç‰©æµè¡Œä¸š"),
"000100": ("TCLç§‘æŠ€", "å…‰å­¦å…‰ç”µå­"),
"000538": ("äº‘å—ç™½è¯", "ä¸­è¯"),
"002837": ("è‹±ç»´å…‹", "ä¸“ç”¨è®¾å¤‡"),
"000977": ("æµªæ½®ä¿¡æ¯", "è®¡ç®—æœºè®¾å¤‡"),
"002466": ("å¤©é½é”‚ä¸š", "èƒ½æºé‡‘å±"),
"600415": ("å°å•†å“åŸ", "å•†ä¸šç™¾è´§"),
"601869": ("é•¿é£å…‰çº¤", "é€šä¿¡è®¾å¤‡"),
"601360": ("ä¸‰å…­é›¶", "è½¯ä»¶å¼€å‘"),
"601872": ("æ‹›å•†è½®èˆ¹", "èˆªè¿æ¸¯å£"),
"600438": ("é€šå¨è‚¡ä»½", "å…‰ä¼è®¾å¤‡"),
"002709": ("å¤©èµææ–™", "åŒ–å­¦åˆ¶å“"),
"002311": ("æµ·å¤§é›†å›¢", "å†œç‰§é¥²æ¸”"),
"600875": ("ä¸œæ–¹ç”µæ°”", "ç”µæºè®¾å¤‡"),
"002558": ("å·¨äººç½‘ç»œ", "æ¸¸æˆ"),
"600673": ("ä¸œé˜³å…‰", "ç»¼åˆè¡Œä¸š"),
"002353": ("æ°ç‘è‚¡ä»½", "ä¸“ç”¨è®¾å¤‡"),
"001979": ("æ‹›å•†è›‡å£", "æˆ¿åœ°äº§å¼€å‘"),
"002920": ("å¾·èµ›è¥¿å¨", "æ±½è½¦é›¶éƒ¨ä»¶"),
"000708": ("ä¸­ä¿¡ç‰¹é’¢", "é’¢é“è¡Œä¸š"),
"600703": ("ä¸‰å®‰å…‰ç”µ", "å…‰å­¦å…‰ç”µå­"),
"000975": ("å±±é‡‘å›½é™…", "è´µé‡‘å±"),
"002001": ("æ–° å’Œ æˆ", "åŒ–å­¦åˆ¶è¯"),
"000938": ("ç´«å…‰è‚¡ä»½", "äº’è”ç½‘æœåŠ¡"),
"605117": ("å¾·ä¸šè‚¡ä»½", "å…‰ä¼è®¾å¤‡"),
"601061": ("ä¸­ä¿¡é‡‘å±", "è´¸æ˜“è¡Œä¸š"),
"600176": ("ä¸­å›½å·¨çŸ³", "ç»ç’ƒç»çº¤"),
"002074": ("å›½è½©é«˜ç§‘", "ç”µæ± "),
"603195": ("å…¬ç‰›é›†å›¢", "å®¶ç”¨è½»å·¥"),
"600048": ("ä¿åˆ©å‘å±•", "æˆ¿åœ°äº§å¼€å‘"),
"600580": ("å§é¾™ç”µé©±", "ç”µæœº"),
"600196": ("å¤æ˜ŸåŒ»è¯", "åŒ–å­¦åˆ¶è¯"),
"600426": ("åé²æ’å‡", "åŒ–å­¦åŸæ–™"),
"001391": ("å›½è´§èˆª", "ç‰©æµè¡Œä¸š"),
"601808": ("ä¸­æµ·æ²¹æœ", "é‡‡æ˜è¡Œä¸š"),
"600895": ("å¼ æ±Ÿé«˜ç§‘", "æˆ¿åœ°äº§å¼€å‘"),
"002131": ("åˆ©æ¬§è‚¡ä»½", "äº’è”ç½‘æœåŠ¡"),
"000301": ("ä¸œæ–¹ç››è™¹", "åŒ–å­¦åŸæ–™"),
"600845": ("å®ä¿¡è½¯ä»¶", "äº’è”ç½‘æœåŠ¡"),
"002595": ("è±ªè¿ˆç§‘æŠ€", "ä¸“ç”¨è®¾å¤‡"),
"002080": ("ä¸­æç§‘æŠ€", "ç»ç’ƒç»çº¤"),
"001965": ("æ‹›å•†å…¬è·¯", "é“è·¯å…¬è·¯"),
"601607": ("ä¸Šæµ·åŒ»è¯", "åŒ»è¯å•†ä¸š"),
"600096": ("äº‘å¤©åŒ–", "åŒ–è‚¥è¡Œä¸š"),
"600522": ("ä¸­å¤©ç§‘æŠ€", "é€šä¿¡è®¾å¤‡"),
"603260": ("åˆç››ç¡…ä¸š", "éé‡‘å±ææ–™"),
"600570": ("æ’ç”Ÿç”µå­", "è½¯ä»¶å¼€å‘"),
"002555": ("ä¸‰ä¸ƒäº’å¨±", "æ¸¸æˆ"),
"603659": ("ç’æ³°æ¥", "ç”µæ± "),
"600803": ("æ–°å¥¥è‚¡ä»½", "ç‡ƒæ°”"),
"002064": ("åå³°åŒ–å­¦", "åŒ–çº¤è¡Œä¸š"),
"600292": ("ç”µæŠ•æ°´ç”µ", "ç¯ä¿è¡Œä¸š"),
"600377": ("å®æ²ªé«˜é€Ÿ", "é“è·¯å…¬è·¯"),
"603392": ("ä¸‡æ³°ç”Ÿç‰©", "ç”Ÿç‰©åˆ¶å“"),
"600482": ("ä¸­å›½åŠ¨åŠ›", "èˆ¹èˆ¶åˆ¶é€ "),
"002851": ("éº¦æ ¼ç±³ç‰¹", "ç”µæºè®¾å¤‡"),
"002812": ("æ©æ·è‚¡ä»½", "ç”µæ± "),
"600143": ("é‡‘å‘ç§‘æŠ€", "å¡‘æ–™åˆ¶å“"),
"000039": ("ä¸­é›†é›†å›¢", "é€šç”¨è®¾å¤‡"),
"601058": ("èµ›è½®è½®èƒ", "æ©¡èƒ¶åˆ¶å“"),
"600801": ("åæ–°å»ºæ", "æ°´æ³¥å»ºæ"),
"002008": ("å¤§æ—æ¿€å…‰", "é€šç”¨è®¾å¤‡"),
"603049": ("ä¸­ç­–æ©¡èƒ¶", "æ©¡èƒ¶åˆ¶å“"),
"000999": ("åæ¶¦ä¸‰ä¹", "ä¸­è¯"),
"603979": ("é‡‘è¯šä¿¡", "é‡‡æ˜è¡Œä¸š"),
"000987": ("è¶Šç§€èµ„æœ¬", "å¤šå…ƒé‡‘è"),
"002409": ("é›…å…‹ç§‘æŠ€", "ç”µå­åŒ–å­¦å“"),
"000564": ("ä¾›é”€å¤§é›†", "å•†ä¸šç™¾è´§"),
"603568": ("ä¼Ÿæ˜ç¯ä¿", "ç¯ä¿è¡Œä¸š"),
"600637": ("ä¸œæ–¹æ˜ç ", "æ–‡åŒ–ä¼ åª’"),
"601615": ("æ˜é˜³æ™ºèƒ½", "é£ç”µè®¾å¤‡"),
"002444": ("å·¨æ˜Ÿç§‘æŠ€", "é€šç”¨è®¾å¤‡"),
"600685": ("ä¸­èˆ¹é˜²åŠ¡", "èˆ¹èˆ¶åˆ¶é€ "),
"600871": ("çŸ³åŒ–æ²¹æœ", "é‡‡æ˜è¡Œä¸š"),
"603119": ("æµ™æ±Ÿè£æ³°", "éé‡‘å±ææ–™"),
"000786": ("åŒ—æ–°å»ºæ", "è£…ä¿®å»ºæ"),
"603087": ("ç”˜æè¯ä¸š", "ç”Ÿç‰©åˆ¶å“"),
"601933": ("æ°¸è¾‰è¶…å¸‚", "å•†ä¸šç™¾è´§"),
"002078": ("å¤ªé˜³çº¸ä¸š", "é€ çº¸å°åˆ·"),
"603129": ("æ˜¥é£åŠ¨åŠ›", "äº¤è¿è®¾å¤‡"),
"002252": ("ä¸Šæµ·è±å£«", "ç”Ÿç‰©åˆ¶å“"),
"002223": ("é±¼è·ƒåŒ»ç–—", "åŒ»ç–—å™¨æ¢°"),
"000876": ("æ–° å¸Œ æœ›", "å†œç‰§é¥²æ¸”"),
"002130": ("æ²ƒå°”æ ¸æ", "éé‡‘å±ææ–™"),
"002821": ("å‡¯è±è‹±", "åŒ»ç–—æœåŠ¡"),
"000877": ("å¤©å±±è‚¡ä»½", "æ°´æ³¥å»ºæ"),
"603650": ("å½¤ç¨‹æ–°æ", "æ©¡èƒ¶åˆ¶å“"),
"600517": ("å›½ç½‘è‹±å¤§", "å¤šå…ƒé‡‘è"),
"002487": ("å¤§é‡‘é‡å·¥", "é£ç”µè®¾å¤‡"),
"603929": ("äºšç¿”é›†æˆ", "è£…ä¿®è£…é¥°"),
"002271": ("ä¸œæ–¹é›¨è™¹", "è£…ä¿®å»ºæ"),
"000158": ("å¸¸å±±åŒ—æ˜", "ç»¼åˆè¡Œä¸š"),
"600177": ("é›…æˆˆå°”", "çººç»‡æœè£…"),
"603833": ("æ¬§æ´¾å®¶å±…", "è£…ä¿®å»ºæ"),
"600956": ("æ–°å¤©ç»¿èƒ½", "ç‡ƒæ°”"),
"600967": ("å†…è’™ä¸€æœº", "äº¤è¿è®¾å¤‡"),
"605090": ("ä¹ä¸°èƒ½æº", "ç‡ƒæ°”"),
"603127": ("æ˜­è¡æ–°è¯", "åŒ»ç–—æœåŠ¡"),
"603728": ("é¸£å¿—ç”µå™¨", "ç”µæœº"),
"603000": ("äººæ°‘ç½‘", "æ–‡åŒ–ä¼ åª’"),
"003021": ("å…†å¨æœºç”µ", "ç”µæœº"),
"600398": ("æµ·æ¾œä¹‹å®¶", "çººç»‡æœè£…"),
"601208": ("ä¸œæç§‘æŠ€", "å¡‘æ–™åˆ¶å“"),
"600754": ("é”¦æ±Ÿé…’åº—", "æ—…æ¸¸é…’åº—"),
"600486": ("æ‰¬å†œåŒ–å·¥", "å†œè¯å…½è¯"),
"603605": ("ç€è±é›…", "ç¾å®¹æŠ¤ç†"),
"001386": ("é©¬å¯æ³¢ç½—", "å®¶ç”¨è½»å·¥"),
"603939": ("ç›Šä¸°è¯æˆ¿", "åŒ»è¯å•†ä¸š"),
"600153": ("å»ºå‘è‚¡ä»½", "è´¸æ˜“è¡Œä¸š"),
"600998": ("ä¹å·é€š", "åŒ»è¯å•†ä¸š"),
"000009": ("ä¸­å›½å®å®‰", "ç»¼åˆè¡Œä¸š"),
"603899": ("æ™¨å…‰è‚¡ä»½", "å®¶ç”¨è½»å·¥"),
"002831": ("è£•åŒç§‘æŠ€", "é€ çº¸å°åˆ·"),
"603360": ("ç™¾å‚²åŒ–å­¦", "å†œè¯å…½è¯"),
"600612": ("è€å‡¤ç¥¥", "ç å®é¦–é¥°"),
"600323": ("ç€šè“ç¯å¢ƒ", "ç¯ä¿è¡Œä¸š"),
"600629": ("åå»ºé›†å›¢", "å·¥ç¨‹å’¨è¯¢æœåŠ¡"),
"600008": ("é¦–åˆ›ç¯ä¿", "å…¬ç”¨äº‹ä¸š"),
"601158": ("é‡åº†æ°´åŠ¡", "å…¬ç”¨äº‹ä¸š"),
"603698": ("èˆªå¤©å·¥ç¨‹", "ä¸“ä¸šæœåŠ¡"),
"603658": ("å®‰å›¾ç”Ÿç‰©", "åŒ»ç–—å™¨æ¢°"),
"002324": ("æ™®åˆ©ç‰¹", "å¡‘æ–™åˆ¶å“"),
"000598": ("å…´è“‰ç¯å¢ƒ", "å…¬ç”¨äº‹ä¸š"),
"002901": ("å¤§åšåŒ»ç–—", "åŒ»ç–—å™¨æ¢°"),
"600655": ("è±«å›­è‚¡ä»½", "ç å®é¦–é¥°"),
"603662": ("æŸ¯åŠ›ä¼ æ„Ÿ", "ä»ªå™¨ä»ªè¡¨"),
"600201": ("ç”Ÿç‰©è‚¡ä»½", "å†œè¯å…½è¯"),
"000061": ("å†œ äº§ å“", "è´¸æ˜“è¡Œä¸š"),
"600258": ("é¦–æ—…é…’åº—", "æ—…æ¸¸é…’åº—"),
"003035": ("å—ç½‘èƒ½æº", "ä¸“ä¸šæœåŠ¡"),
"002607": ("ä¸­å…¬æ•™è‚²", "æ•™è‚²"),
"601965": ("ä¸­å›½æ±½ç ”", "æ±½è½¦æœåŠ¡"),
"600720": ("ä¸­äº¤è®¾è®¡", "å·¥ç¨‹å’¨è¯¢æœåŠ¡"),
"002643": ("ä¸‡æ¶¦è‚¡ä»½", "ç”µå­åŒ–å­¦å“"),
"002565": ("é¡ºçè‚¡ä»½", "åŒ…è£…ææ–™"),
"603733": ("ä»™é¹¤è‚¡ä»½", "é€ çº¸å°åˆ·"),
"002969": ("å˜‰ç¾åŒ…è£…", "åŒ…è£…ææ–™"),
"600315": ("ä¸Šæµ·å®¶åŒ–", "ç¾å®¹æŠ¤ç†"),
"002701": ("å¥¥ç‘é‡‘", "åŒ…è£…ææ–™"),
"601718": ("é™…åé›†å›¢", "çººç»‡æœè£…"),
"002967": ("å¹¿ç”µè®¡é‡", "ä¸“ä¸šæœåŠ¡"),
"002338": ("å¥¥æ™®å…‰ç”µ", "ä»ªå™¨ä»ªè¡¨"),
"605599": ("èœç™¾è‚¡ä»½", "ç å®é¦–é¥°"),
"603983": ("ä¸¸ç¾ç”Ÿç‰©", "ç¾å®¹æŠ¤ç†"),
"603100": ("å·ä»ªè‚¡ä»½", "ä»ªå™¨ä»ªè¡¨"),
"001914": ("æ‹›å•†ç§¯ä½™", "æˆ¿åœ°äº§æœåŠ¡"),
"603216": ("æ¢¦å¤©å®¶å±…", "è£…ä¿®è£…é¥°"),
"600604": ("å¸‚åŒ—é«˜æ–°", "æˆ¿åœ°äº§æœåŠ¡"),
"001212": ("ä¸­æ——æ–°æ", "è£…ä¿®è£…é¥°"),
"002741": ("å…‰åç§‘æŠ€", "ç”µå­åŒ–å­¦å“"),
"600335": ("å›½æœºæ±½è½¦", "æ±½è½¦æœåŠ¡"),
"000928": ("ä¸­é’¢å›½é™…", "å·¥ç¨‹å’¨è¯¢æœåŠ¡"),
"000753": ("æ¼³å·å‘å±•", "æ±½è½¦æœåŠ¡"),
"000560": ("æˆ‘çˆ±æˆ‘å®¶", "æˆ¿åœ°äº§æœåŠ¡"),
"600730": ("ä¸­å›½é«˜ç§‘", "æ•™è‚²"),
"600880": ("åšç‘ä¼ æ’­", "æ•™è‚²")

}
for k, v in STRATEGIC_POOL.items():
    if isinstance(v, str): STRATEGIC_POOL[k] = (v, "å…¶ä»–")

PARAMS = {
    'MA_LIFE': 20, 'MA_BULL': 40, 'RSI_N': 14, 'ATR_N': 14, 'VOL_MA': 20,
    'BIAS_LIMIT': 1.12, 'RSI_MIN': 50, 'RSI_MAX': 75,
    'VOL_MIN': 1.0, 'VOL_MAX': 2.5, 'STOP_LOSS': -0.08
}

# ==================== æ ¸å¿ƒç®—æ³• ====================
class AlgoEngine:
    @staticmethod
    def get_snapshot():
        """è·å–å…¨å¸‚åœºå®æ—¶å¿«ç…§ (ä¸ç¼“å­˜ï¼Œä¿è¯å®æ—¶æ€§)"""
        try:
            df = ak.stock_zh_a_spot_em()
            snap = {}
            for _, row in df.iterrows():
                snap[str(row['ä»£ç '])] = {
                    'close': float(row['æœ€æ–°ä»·']), 'high': float(row['æœ€é«˜']),
                    'low': float(row['æœ€ä½']), 'open': float(row['ä»Šå¼€']),
                    'volume': float(row['æˆäº¤é‡'])
                }
            return snap
        except: return None

    @staticmethod
    def sync_history():
        """ä¸‹è½½å†å²æ•°æ® (æ‰‹åŠ¨è§¦å‘)"""
        if not os.path.exists(STOCK_DIR): os.makedirs(STOCK_DIR)
        
        status = st.status("ğŸ“¡ æ­£åœ¨åŒæ­¥å†å²æ•°æ®...", expanded=True)
        end = datetime.now().strftime("%Y%m%d")
        start = (datetime.now() - timedelta(days=800)).strftime("%Y%m%d")
        
        # 1. å¤§ç›˜
        try:
            status.write("ä¸‹è½½æ²ªæ·±300æŒ‡æ•°...")
            try: df = ak.stock_zh_index_daily_em(symbol="sh000300")
            except: df = ak.stock_zh_index_daily(symbol="sh000300")
            rename_map = {'date': 'æ—¥æœŸ', 'close': 'æ”¶ç›˜', 'open': 'å¼€ç›˜', 'high': 'æœ€é«˜', 'low': 'æœ€ä½', 'volume': 'æˆäº¤é‡'}
            df.rename(columns=rename_map, inplace=True)
            df.to_csv(os.path.join(STOCK_DIR, "sh000300.csv"), index=False)
        except Exception as e:
            status.write(f"âš ï¸ å¤§ç›˜åŒæ­¥è­¦å‘Š: {e}")

        # 2. ä¸ªè‚¡
        status.write(f"æ­£åœ¨åŒæ­¥ {len(STRATEGIC_POOL)} åªæ ¸å¿ƒèµ„äº§...")
        bar = status.progress(0)
        cnt = 0
        total = len(STRATEGIC_POOL)
        for i, code in enumerate(STRATEGIC_POOL.keys()):
            try:
                df = ak.stock_zh_a_hist(symbol=code, start_date=start, end_date=end, adjust="qfq")
                if not df.empty:
                    df.to_csv(os.path.join(STOCK_DIR, f"{code}.csv"), index=False)
                    cnt += 1
            except: pass
            bar.progress((i + 1) / total)
        
        # æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶ä¸‹æ¬¡é‡æ–°è¯»å–æ–°æ–‡ä»¶
        st.cache_data.clear()
        status.update(label=f"âœ… åŒæ­¥å®Œæˆï¼è¦†ç›– {cnt} åªè‚¡ç¥¨ã€‚", state="complete", expanded=False)

    @staticmethod
    @st.cache_data(ttl=3600) # ç¼“å­˜å†å²è¯»å–ï¼Œ1å°æ—¶å¤±æ•ˆï¼Œæå‡é€Ÿåº¦
    def get_history_df(code):
        """è¯»å–æœ¬åœ°å†å²CSV"""
        path = os.path.join(STOCK_DIR, f"{code}.csv")
        if not os.path.exists(path): return None
        try:
            df = pd.read_csv(path)
            rename_map = {'æ—¥æœŸ':'date', 'å¼€ç›˜':'open', 'æ”¶ç›˜':'close', 'æœ€é«˜':'high', 'æœ€ä½':'low', 'æˆäº¤é‡':'volume'}
            df.rename(columns=rename_map, inplace=True)
            df['date'] = pd.to_datetime(df['date'])
            df.set_index('date', inplace=True)
            return df
        except: return None

    @staticmethod
    def process_stock(code, snapshot_data):
        """æ ¸å¿ƒè®¡ç®—é€»è¾‘"""
        # 1. è·å–ç¼“å­˜çš„å†å²æ•°æ®
        df = AlgoEngine.get_history_df(code)
        if df is None: return None
        
        try:
            # 2. æ‹¼æ¥å®æ—¶æ•°æ® (å¿…é¡»æ·±æ‹·è´ï¼Œé˜²æ­¢æ±¡æŸ“ç¼“å­˜)
            df = df.copy()
            
            if snapshot_data:
                today = datetime.now().replace(hour=0,minute=0,second=0,microsecond=0)
                if today not in df.index:
                    df.loc[today] = [snapshot_data['open'], snapshot_data['close'], snapshot_data['high'], snapshot_data['low'], snapshot_data['volume']] + [0]*(len(df.columns)-5)
                else:
                    # å¦‚æœä»Šå¤©å·²æœ‰æ•°æ®(æ¯”å¦‚ç›˜ååŒæ­¥è¿‡)ï¼Œç”¨å¿«ç…§è¦†ç›–
                    df.loc[today, ['open','close','high','low','volume']] = [snapshot_data['open'], snapshot_data['close'], snapshot_data['high'], snapshot_data['low'], snapshot_data['volume']]
            
            # 3. å‘¨çº¿é‡é‡‡æ ·
            df_w = df.resample('W-FRI').agg({'open': 'first', 'high': 'max', 'low': 'min', 'close': 'last', 'volume': 'sum'})
            close = df_w['close']
            
            # 4. æŒ‡æ ‡è®¡ç®— (V19.3æ ‡å‡†)
            df_w['MA20'] = close.rolling(PARAMS['MA_LIFE']).mean()
            df_w['MA20_Up'] = df_w['MA20'] > df_w['MA20'].shift(1)
            df_w['Vol_MA20'] = df_w['volume'].rolling(PARAMS['VOL_MA']).mean()
            
            # RSI (EMA)
            delta = close.diff()
            gain = (delta.where(delta > 0, 0)).ewm(com=PARAMS['RSI_N']-1, adjust=False).mean()
            loss = (-delta.where(delta < 0, 0)).ewm(com=PARAMS['RSI_N']-1, adjust=False).mean()
            rs = gain / loss
            df_w['RSI'] = 100 - (100 / (1 + rs))
            
            # ATR (EMA)
            tr1 = df_w['high'] - df_w['low']
            tr2 = abs(df_w['high'] - close.shift(1))
            tr3 = abs(df_w['low'] - close.shift(1))
            tr = pd.concat([tr1, tr2, tr3], axis=1).max(axis=1)
            df_w['ATR'] = tr.ewm(com=PARAMS['ATR_N']-1, adjust=False).mean()
            
            # 5. æå–ç»“æœ
            cur = df_w.iloc[-1].to_dict()
            cur['code'] = code
            cur['name'] = STRATEGIC_POOL[code][0]
            cur['ind'] = STRATEGIC_POOL[code][1]
            cur['date_str'] = df_w.index[-1].strftime("%Y-%m-%d")
            
            # é€»è¾‘å‚æ•°
            cur['Bias'] = cur['close'] / cur['MA20'] if cur['MA20'] else 0
            cur['Vol_Ratio'] = cur['volume'] / cur['Vol_MA20'] if cur['Vol_MA20']>0 else 0
            cur['Amount'] = cur['close'] * cur['volume']
            
            body = abs(cur['close'] - cur['open'])
            upper = cur['high'] - max(cur['open'], cur['close'])
            cur['Structure_OK'] = body >= upper
            
            return cur
        except: return None

    @staticmethod
    def get_market_status():
        path = os.path.join(STOCK_DIR, "sh000300.csv")
        if not os.path.exists(path): return False, 0, 0, "æ— æ•°æ®ï¼Œè¯·å…ˆåŒæ­¥"
        try:
            df = pd.read_csv(path)
            rename_map = {'date': 'æ—¥æœŸ', 'close': 'æ”¶ç›˜', 'open': 'å¼€ç›˜', 'high': 'æœ€é«˜', 'low': 'æœ€ä½', 'volume': 'æˆäº¤é‡'}
            df.rename(columns=rename_map, inplace=True)
            
            df['æ—¥æœŸ'] = pd.to_datetime(df['æ—¥æœŸ'])
            df.set_index('æ—¥æœŸ', inplace=True)
            
            df_w = df.resample('W-FRI').agg({'æ”¶ç›˜': 'last'})
            df_w['MA40'] = df_w['æ”¶ç›˜'].rolling(PARAMS['MA_BULL']).mean()
            
            last = df_w.iloc[-1]
            prev = df_w.iloc[-2]
            
            is_bull = (last['æ”¶ç›˜'] > last['MA40']) and (last['MA40'] >= prev['MA40'] * 0.9995)
            date_str = df_w.index[-1].strftime("%Y-%m-%d")
            return is_bull, last['æ”¶ç›˜'], last['MA40'], date_str
        except Exception as e: return False, 0, 0, str(e)

# ==================== Web ç•Œé¢ ====================
st.title("ğŸš€ Aè‚¡ V20.6 æé€Ÿå®æˆ˜æŒ‡æŒ¥èˆ±")
st.markdown("---")

# ä¾§è¾¹æ 
with st.sidebar:
    st.header("1. æˆ˜å‰æ•´å¤‡")
    if st.button("ğŸ”„ åŒæ­¥æœ€æ–°æ•°æ® (å‘¨äº”å¿…ç‚¹)", type="primary"):
        AlgoEngine.sync_history()
        
    cash = st.number_input("å¯ç”¨èµ„é‡‘ (å…ƒ):", value=20000.0, step=1000.0)
    mode = st.radio("ç­–ç•¥æ¨¡å¼:", ["V12 æ¿€è¿› (æ¢­å“ˆ)", "V11 ç¨³å¥ (åŠä»“)"])
    
    st.markdown("### æŒä»“å½•å…¥")
    st.caption("æ ¼å¼: ä»£ç ,æˆæœ¬,è‚¡æ•°,æœ€é«˜ä»· (V12å¿…å¡«)")
    pos_input = st.text_area("è¾“å…¥:", height=100, placeholder="601138, 22.5, 500, 25.0")

# ä¸»ç¨‹åº
if st.button("ğŸš€ å¯åŠ¨å…¨æµç¨‹è¯Šæ–­ (æé€Ÿç‰ˆ)", use_container_width=True):
    
    # 0. è§£ææŒä»“
    positions = []
    if pos_input:
        for line in pos_input.split('\n'):
            p = line.replace('ï¼Œ', ',').split(',')
            if len(p)>=3:
                try: positions.append({'code':p[0].strip(), 'cost':float(p[1]), 'shares':int(p[2]), 'high':float(p[3]) if len(p)>3 else float(p[1])})
                except: pass

    # è·å–å¿«ç…§ (æ¯æ¬¡ç‚¹å‡»å¿…åšï¼Œç¡®ä¿å®æ—¶)
    with st.spinner("æ­£åœ¨è·å–å®æ—¶è¡Œæƒ…..."):
        snapshot = AlgoEngine.get_snapshot()
        if not snapshot: 
            st.warning("âš ï¸ å®æ—¶æ•°æ®è·å–å¤±è´¥ï¼Œæ­£åœ¨ä½¿ç”¨å†å²æ•°æ®ï¼ˆæ˜¨æ—¥æ”¶ç›˜ï¼‰è¿›è¡Œè®¡ç®—...")
    
    # --- Step 1: ç¯å¢ƒ ---
    st.subheader("ğŸ“Š Step 1: å¸‚åœºç¯å¢ƒ")
    is_bull, idx_price, idx_ma, idx_date = AlgoEngine.get_market_status()
    
    if idx_price == 0:
        st.error(f"âŒ æ•°æ®é”™è¯¯: {idx_date}ã€‚è¯·å…ˆç‚¹å‡»ä¾§è¾¹æ çš„ã€åŒæ­¥æœ€æ–°æ•°æ®ã€‘ï¼")
    else:
        col1, col2, col3 = st.columns(3)
        col1.metric("æ²ªæ·±300", f"{idx_price:.2f}")
        col2.metric("ç‰›ç†Šçº¿ (MA40)", f"{idx_ma:.2f}")
        col3.metric("çŠ¶æ€", "ğŸŸ¢ ç‰›å¸‚" if is_bull else "ğŸ”´ ç†Šå¸‚")
        st.caption(f"æ•°æ®åŸºå‡†æ—¥: {idx_date}")

        # --- Step 2: æŒä»“ ---
        st.subheader("ğŸ›¡ï¸ Step 2: æŒä»“è¯Šæ–­")
        simulated_cash = cash
        active_pos = 0
        
        if positions:
            for p in positions:
                d = AlgoEngine.process_stock(p['code'], snapshot.get(p['code']) if snapshot else None)
                if not d: continue
                
                price = d['close']
                pct = (price - p['cost']) / p['cost'] if p['cost']!=0 else 0
                
                reason = None
                if pct <= PARAMS['STOP_LOSS']: reason = f"ç¡¬æ­¢æŸ(äº{pct:.1%})"
                elif price < d['MA20'] and not d['MA20_Up']: reason = "è¶‹åŠ¿ç ´å"
                
                if "V12" in mode:
                    stop_line = p['high'] - (3.0 * d['ATR'])
                    if price < stop_line: reason = f"ATRæ­¢ç›ˆ(ç ´{stop_line:.2f})"
                
                c1, c2 = st.columns([3, 1])
                with c1:
                    st.write(f"**{d['name']}** ({p['code']})")
                    st.caption(f"ç°ä»·:{price} | æˆæœ¬:{p['cost']} | ç›ˆäº:{pct:.2%}")
                    st.caption(f"æ¿å—: {d['ind']} | é‡æ¯”: {d['Vol_Ratio']:.1f}")
                    if "V12" in mode: st.caption(f"æœ€é«˜ä»·:{p['high']} | æ­¢ç›ˆçº¿:{stop_line:.2f}")
                with c2:
                    if reason:
                        st.error(f"âŒ å–å‡º\n{reason}")
                        simulated_cash += price * p['shares']
                    else:
                        st.success("âœ… æŒæœ‰")
                        active_pos += 1
                        if price > p['high']: st.info("åˆ›æ–°é«˜!è¯·æ›´æ–°")
                st.divider()
        else:
            st.info("å½“å‰ç©ºä»“")

        # --- Step 3: é€‰è‚¡ ---
        if is_bull:
            st.subheader("ğŸ” Step 3: é€‰è‚¡å…¨æ™¯é€è§†")
            
            candidates = []
            table_data = []
            
            progress_text = "æé€Ÿæ‰«æä¸­..."
            my_bar = st.progress(0, text=progress_text)
            total_scan = len(STRATEGIC_POOL)
            
            for i, code in enumerate(STRATEGIC_POOL):
                my_bar.progress((i + 1) / total_scan)
                if any(p['code'] == code for p in positions): continue
                
                d = AlgoEngine.process_stock(code, snapshot.get(code) if snapshot else None)
                if not d: continue
                
                res = "âŒ"
                why = []
                
                if not (d['MA20_Up'] and d['close'] > d['MA20']): why.append("MA20å‘ä¸‹")
                if d['Bias'] > PARAMS['BIAS_LIMIT']: why.append(f"ä½ç½®é«˜({d['Bias']:.2f})")
                if not (PARAMS['RSI_MIN'] <= d['RSI'] <= PARAMS['RSI_MAX']): why.append(f"RSI({d['RSI']:.0f})")
                if not (PARAMS['VOL_MIN'] <= d['Vol_Ratio'] <= PARAMS['VOL_MAX']): why.append(f"é‡({d['Vol_Ratio']:.1f})")
                if not d['Structure_OK']: why.append("ç»“æ„å·®")
                
                # èµ„é‡‘è¿‡æ»¤
                cost_per_hand = d['close'] * 100
                if cost_per_hand > simulated_cash: why.append(f"èµ„é‡‘ä¸è¶³({cost_per_hand:.0f})")
                
                if not why:
                    res = "âœ…"
                    candidates.append(d)
                    
                table_data.append({
                    "ä»£ç ": code, "åç§°": d['name'], "æ¿å—": d['ind'],
                    "ç°ä»·": f"{d['close']:.2f}",
                    "RSI": f"{d['RSI']:.1f}", 
                    "ä¹–ç¦»": f"{d['Bias']:.2f}",
                    "é‡æ¯”": f"{d['Vol_Ratio']:.1f}",
                    "è¯Šæ–­": res, "åŸå› ": " ".join(why)
                })
                
            my_bar.empty()
            
            # ä¼˜åŒ–è¡¨æ ¼æ˜¾ç¤º (æ·»åŠ å­—æ®µ)
            df_table = pd.DataFrame(table_data)
            st.dataframe(
                df_table, 
                use_container_width=True, 
                hide_index=True,
                column_config={
                    "è¯Šæ–­": st.column_config.TextColumn(
                        "è¯Šæ–­",
                        help="âœ…è¡¨ç¤ºå¯ä¹°ï¼ŒâŒè¡¨ç¤ºæ·˜æ±°",
                        validate="^âœ…"
                    )
                }
            )

            # --- Step 4: å†³ç­– ---
            st.subheader("ğŸ’¡ Step 4: æœ€ç»ˆæŒ‡ä»¤")
            
            if not candidates:
                st.warning("æ‰«æç»“æŸï¼Œæ— ç¬¦åˆV19æ ‡å‡†æ ‡çš„ã€‚")
            else:
                candidates.sort(key=lambda x: (x['RSI'], x['Amount']), reverse=True)
                target = candidates[0]
                
                invest = simulated_cash * 0.5 if "V11" in mode or active_pos == 0 else simulated_cash * 0.99
                if active_pos >= 2 and "V12" in mode:
                    st.warning("V12ä»“ä½å·²æ»¡ï¼Œåœæ­¢ä¹°å…¥ã€‚")
                else:
                    shares = int(invest / target['close'] / 100) * 100
                    
                    # å¼ºåˆ¶ä¿åº•
                    if shares < 100:
                        if simulated_cash >= target['close'] * 100:
                            shares = 100
                            st.info("âš ï¸ ç­–ç•¥åˆ†é…èµ„é‡‘ä¸è¶³ï¼Œä½†æ€»ç°é‡‘è¶³å¤Ÿï¼Œå¯ç”¨ã€å¼ºåˆ¶ä¿åº•ã€‘ä¹°å…¥1æ‰‹ã€‚")
                        else:
                            st.error(f"é€‰ä¸­ {target['name']}ï¼Œä½†è¿1æ‰‹éƒ½ä¹°ä¸èµ· (éœ€{target['close']*100:.0f})ã€‚")
                            shares = 0
                    
                    if shares >= 100:
                        st.success(f"â­â­â­ ä¹°å…¥æŒ‡ä»¤: {target['name']} ({target['code']})")
                        col1, col2, col3 = st.columns(3)
                        col1.metric("ä¹°å…¥æ•°é‡", f"{shares} è‚¡")
                        col2.metric("RSIå¼ºåº¦", f"{target['RSI']:.1f}")
                        col3.metric("é¢„è®¡è€—èµ„", f"{shares * target['close']:.0f} å…ƒ")
    else:
        st.error("å¤§ç›˜çº¢ç¯ï¼Œåœæ­¢é€‰è‚¡ã€‚")
